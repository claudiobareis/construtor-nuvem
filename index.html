<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8">
  <title>Pagebuilder Nuvemshop - Estrutura e Indicador</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.quilljs.com/2.0.0-dev.2/quill.snow.css" rel="stylesheet">
  <link href="https://cdn.quilljs.com/2.0.0-dev.2/quill.bubble.css" rel="stylesheet">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
  <style>
    body { 
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      padding: 20px 0;
    }
    
    .main-container {
      background: white;
      border-radius: 15px;
      box-shadow: 0 20px 40px rgba(0,0,0,0.1);
      padding: 30px;
      margin: 20px auto;
      max-width: 1400px;
    }
    
    .page-header {
      text-align: center;
      margin-bottom: 30px;
      padding-bottom: 20px;
      border-bottom: 2px solid #f8f9fa;
    }
    
    .page-header h2 {
      color: #2c3e50;
      font-weight: 700;
      margin-bottom: 10px;
    }
    
    .page-header p {
      color: #7f8c8d;
      font-size: 16px;
    }
    
    .container-controls {
      background: #f8f9fa;
      padding: 20px;
      border-radius: 10px;
      margin-bottom: 30px;
      text-align: center;
    }
    
    .btn-container {
      background: linear-gradient(45deg, #667eea, #764ba2);
      color: white;
      border: none;
      padding: 12px 24px;
      border-radius: 25px;
      margin: 5px;
      font-weight: 600;
      transition: all 0.3s ease;
      box-shadow: 0 4px 15px rgba(0,0,0,0.1);
    }
    
    .btn-container:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(0,0,0,0.15);
      color: white;
    }
    
    .btn-container:active {
      transform: translateY(0);
    }
    
    .container-item {
      background: white;
      border: 2px solid #e9ecef;
      border-radius: 12px;
      padding: 20px;
      margin-bottom: 25px;
      position: relative;
      transition: all 0.3s ease;
      box-shadow: 0 4px 15px rgba(0,0,0,0.05);
    }
    
    .container-item:hover {
      border-color: #667eea;
      box-shadow: 0 8px 25px rgba(0,0,0,0.1);
    }
    
    .container-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
      padding-bottom: 15px;
      border-bottom: 1px solid #e9ecef;
    }
    
    .container-title {
      font-weight: 600;
      color: #2c3e50;
      font-size: 18px;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .container-name {
      font-size: 14px;
      color: #6c757d;
      font-weight: 500;
      background: #f8f9fa;
      padding: 4px 8px;
      border-radius: 12px;
      border: 1px solid #dee2e6;
      white-space: nowrap;
    }

    .container-name-input {
      font-size: 14px;
      color: #495057;
      background: #fff;
      border: 1px solid #ced4da;
      border-radius: 8px;
      padding: 4px 8px;
      width: 200px;
      transition: all 0.3s ease;
    }

    .container-name-input:focus {
      border-color: #667eea;
      box-shadow: 0 0 0 0.2rem rgba(102, 126, 234, 0.25);
      outline: none;
    }
    
    .btn-remove {
      background: #e74c3c;
      color: white;
      border: none;
      padding: 8px 16px;
      border-radius: 20px;
      font-size: 12px;
      transition: all 0.3s ease;
    }
    
    .btn-remove:hover {
      background: #c0392b;
      color: white;
      transform: scale(1.05);
    }
    
    .bloco {
      background: #f8f9fa;
      border: 1px solid #dee2e6;
      padding: 20px;
      margin-bottom: 15px;
      border-radius: 8px;
      transition: all 0.3s ease;
    }
    
    .bloco:hover {
      border-color: #667eea;
      box-shadow: 0 4px 15px rgba(0,0,0,0.1);
    }
    
    .drag-handle { 
      background: linear-gradient(45deg, #667eea, #764ba2);
      color: white; 
      padding: 8px 12px; 
      border-radius: 20px; 
      cursor: move; 
      font-size: 12px; 
      margin-bottom: 15px; 
      display: inline-block;
      font-weight: 600;
      transition: all 0.3s ease;
    }
    
    .drag-handle:hover { 
      background: linear-gradient(45deg, #5a6fd8, #6a4190);
      transform: scale(1.05);
    }
    
    .form-label {
      font-weight: 600;
      color: #2c3e50;
      margin-bottom: 8px;
    }
    
    .form-control {
      border-radius: 8px;
      border: 2px solid #e9ecef;
      padding: 12px;
      transition: all 0.3s ease;
    }
    
    .form-control:focus {
      border-color: #667eea;
      box-shadow: 0 0 0 0.2rem rgba(102, 126, 234, 0.25);
    }
    
    .btn-add {
      background: #28a745;
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 25px;
      margin: 5px;
      font-weight: 600;
      transition: all 0.3s ease;
      box-shadow: 0 4px 15px rgba(0,0,0,0.1);
    }
    
    .btn-add:hover {
      background: #218838;
      color: white;
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(0,0,0,0.15);
    }
    
    .btn-remove-block {
      background: #dc3545;
      color: white;
      border: none;
      padding: 6px 12px;
      border-radius: 15px;
      font-size: 11px;
      transition: all 0.3s ease;
      float: right;
    }
    
    .btn-remove-block:hover {
      background: #c82333;
      color: white;
      transform: scale(1.05);
    }
    
    .preview { 
      background: #f8f9fa; 
      padding: 25px; 
      border-radius: 12px; 
      margin-top: 30px;
      border: 2px solid #e9ecef;
    }
    
    .preview h3 {
      color: #2c3e50;
      margin-bottom: 20px;
      font-weight: 600;
    }
    
    .page-builder-push { 
      border: 3px dashed #667eea; 
      padding: 20px; 
      margin-bottom: 30px;
      border-radius: 12px;
      background: rgba(102, 126, 234, 0.05);
    }
    
    .paste-area { 
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      border: none; 
      padding: 25px; 
      margin-top: 30px; 
      border-radius: 15px;
      color: white;
    }
    
    .paste-area h4 {
      color: white;
      margin-bottom: 15px;
      font-weight: 600;
    }
    
    .paste-area textarea { 
      width: 100%; 
      min-height: 120px; 
      font-family: 'Courier New', monospace; 
      font-size: 13px;
      border-radius: 8px;
      border: none;
      padding: 15px;
    }
    
    .btn-copiar { 
      background: #28a745; 
      color: white; 
      border: none; 
      padding: 12px 24px; 
      border-radius: 25px; 
      cursor: pointer;
      font-weight: 600;
      transition: all 0.3s ease;
      box-shadow: 0 4px 15px rgba(0,0,0,0.1);
    }
    
    .btn-copiar:hover {
      background: #218838;
      color: white;
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(0,0,0,0.15);
    }
    
    .btn-generate {
      background: linear-gradient(45deg, #667eea, #764ba2);
      color: white;
      border: none;
      padding: 15px 30px;
      border-radius: 25px;
      font-weight: 600;
      font-size: 16px;
      transition: all 0.3s ease;
      box-shadow: 0 4px 15px rgba(0,0,0,0.1);
      margin: 10px;
    }
    
    .btn-generate:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(0,0,0,0.15);
      color: white;
    }
    
    .quill-editor { 
      height: 150px; 
      margin-bottom: 15px;
      border-radius: 8px;
    }
    
    /* Estilos básicos para tabelas no editor Quill */
    .ql-editor table {
      border-collapse: collapse;
      width: 100%;
      margin: 15px 0;
    }
    
    .ql-editor table td,
    .ql-editor table th {
      padding: 8px;
      text-align: left;
      vertical-align: top;
    }
    
    img { 
      max-width: 100%; 
      border-radius: 8px; 
      margin: 15px 0;
      box-shadow: 0 4px 15px rgba(0,0,0,0.1);
    }
    
    /* Classes específicas para cada tipo de container */
    .push-1-col .col { flex: 1; }
    .push-2-cols .col { flex: 1; }
    .push-3-cols .col { flex: 1; }
    .push-4-cols .col { flex: 1; }
    .push-5-cols .col { flex: 1; }
    
    /* Drag and Drop */
    .draggable { cursor: move; }
    .dragging { opacity: 0.5; }
    .drop-zone { 
      border: 2px dashed #667eea; 
      background: rgba(102, 126, 234, 0.05); 
      min-height: 50px;
      transition: all 0.2s ease;
    }
    .drop-zone.drag-over { 
      background: rgba(102, 126, 234, 0.1); 
      border-color: #5a6fd8; 
      transform: scale(1.02);
      box-shadow: 0 0 20px rgba(102, 126, 234, 0.3);
    }
    
    /* Indicador visual para zonas de drop */
    .col {
      position: relative;
      min-height: 100px;
    }
    .col::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      border: 2px dashed transparent;
      pointer-events: none;
      transition: all 0.2s ease;
    }
    .col.drag-over::before {
      border-color: #667eea;
      background: rgba(102, 126, 234, 0.1);
    }
    
    /* Responsividade */
    @media (max-width: 900px) {
      .row { flex-direction: column; }
      .col { width: 100%; }
      .push-1-col .col,
      .push-2-cols .col,
      .push-3-cols .col,
      .push-4-cols .col,
      .push-5-cols .col { width: 100%; }
    }
    
    @media (min-width: 901px) {
      .push-2-cols .col { flex: 0 0 calc(50% - 8px); }
      .push-3-cols .col { flex: 0 0 calc(33.333% - 8px); }
      .push-4-cols .col { flex: 0 0 calc(25% - 8px); }
      .push-5-cols .col { flex: 0 0 calc(20% - 8px); }
    }

    /* Estilos para a nova estrutura de tabela */
    .table-controls {
      background: #f8f9fa;
      padding: 15px;
      border-radius: 8px;
      margin-bottom: 15px;
      border: 1px solid #dee2e6;
      display: flex;
      flex-wrap: wrap;
      gap: 5px;
      align-items: center;
    }

    .table-controls button {
      background: #667eea;
      color: white;
      border: none;
      padding: 8px 12px;
      border-radius: 4px;
      margin: 2px;
      font-size: 12px;
      cursor: pointer;
      transition: all 0.3s ease;
      display: flex;
      align-items: center;
      gap: 5px;
      font-weight: 500;
    }

    .table-controls button:hover {
      background: #5a6fd8;
      transform: scale(1.05);
      box-shadow: 0 2px 8px rgba(0,0,0,0.15);
    }

    .table-controls button.delete {
      background: #dc3545;
    }

    .table-controls button.delete:hover {
      background: #c82333;
    }

    .table-controls button.add {
      background: #28a745;
    }

    .table-controls button.add:hover {
      background: #218838;
    }

    .table-controls button.insert {
      background: #17a2b8;
    }

    .table-controls button.insert:hover {
      background: #138496;
    }

    .table-controls button i {
      font-size: 11px;
    }

    /* Estilos para funcionalidades de container */
    .container-actions {
      display: flex;
      gap: 8px;
      align-items: center;
      flex-wrap: wrap;
    }

    .btn-move-up, .btn-move-down, .btn-duplicate {
      background: #6c757d;
      color: white;
      border: none;
      padding: 6px 12px;
      border-radius: 15px;
      font-size: 11px;
      transition: all 0.3s ease;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 4px;
    }

    .btn-move-up:hover, .btn-move-down:hover {
      background: #5a6268;
      transform: scale(1.05);
    }

    .btn-move-up:disabled, .btn-move-down:disabled {
      background: #e9ecef;
      color: #6c757d;
      cursor: not-allowed;
      opacity: 0.6;
    }

    .btn-move-up:disabled:hover, .btn-move-down:disabled:hover {
      background: #e9ecef;
      transform: none;
    }

    .btn-duplicate {
      background: #17a2b8;
    }

    .btn-duplicate:hover {
      background: #138496;
      transform: scale(1.05);
    }

    .btn-collapse {
      background: #ffc107;
      color: #212529;
      border: none;
      padding: 6px 12px;
      border-radius: 15px;
      font-size: 11px;
      transition: all 0.3s ease;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 4px;
    }

    .btn-collapse:hover {
      background: #e0a800;
      transform: scale(1.05);
    }

    .container-content {
      transition: all 0.3s ease;
      overflow: hidden;
    }

    .container-content.collapsed {
      max-height: 0;
      opacity: 0;
      padding: 0;
      margin: 0;
    }

    /* Estilo especial quando container está recolhido */
    .container-item.collapsed .container-title .container-name {
      background: linear-gradient(45deg, #667eea, #764ba2);
      color: white;
      font-weight: 600;
      border: none;
      padding: 6px 12px;
      box-shadow: 0 2px 8px rgba(102, 126, 234, 0.3);
    }

    .container-item.collapsed .container-title .container-name .container-name-input {
      background: transparent;
      color: white;
      border: none;
      font-weight: 600;
    }

    .container-item.collapsed .container-title .container-name .container-name-input::placeholder {
      color: rgba(255, 255, 255, 0.7);
    }

    .container-content.expanded {
      max-height: none;
      opacity: 1;
    }

    /* Estilos para drag and drop de containers */
    .container-item.dragging {
      opacity: 0.5;
      transform: rotate(2deg);
    }

    .container-drop-zone {
      border: 2px dashed #667eea;
      background: rgba(102, 126, 234, 0.05);
      min-height: 20px;
      margin: 10px 0;
      border-radius: 8px;
      transition: all 0.2s ease;
    }

                .container-drop-zone.drag-over {
              background: rgba(102, 126, 234, 0.1);
              border-color: #5a6fd8;
              transform: scale(1.02);
              box-shadow: 0 0 20px rgba(102, 126, 234, 0.3);
            }

            /* Estilos para botões de adicionar/remover colunas */
            .btn-add-col, .btn-remove-col {
              background: #17a2b8;
              color: white;
              border: none;
              padding: 6px 12px;
              border-radius: 15px;
              font-size: 11px;
              transition: all 0.3s ease;
              cursor: pointer;
              display: flex;
              align-items: center;
              gap: 4px;
              margin: 0 2px;
            }

            .btn-add-col:hover {
              background: #138496;
              transform: scale(1.05);
            }

            .btn-remove-col {
              background: #dc3545;
            }

            .btn-remove-col:hover {
              background: #c82333;
              transform: scale(1.05);
            }

            .btn-add-col:disabled, .btn-remove-col:disabled {
              background: #e9ecef;
              color: #6c757d;
              cursor: not-allowed;
              opacity: 0.6;
            }

            .btn-add-col:disabled:hover, .btn-remove-col:disabled:hover {
              background: #e9ecef;
              transform: none;
            }



            /* Menu flutuante de gerenciamento de dados */
            .floating-menu {
              position: fixed;
              top: 10%;
              right: 20px;
              transform: translateY(-50%);
              z-index: 1000;
            }

            .floating-menu-btn {
              background: linear-gradient(45deg, #667eea, #764ba2);
              color: white;
              border: none;
              padding: 15px 20px;
              border-radius: 50px;
              font-weight: 600;
              transition: all 0.3s ease;
              box-shadow: 0 8px 25px rgba(0,0,0,0.15);
              display: flex;
              align-items: center;
              gap: 10px;
              cursor: pointer;
              min-width: 180px;
            }

            .floating-menu-btn:hover {
              transform: translateY(-2px);
              box-shadow: 0 12px 35px rgba(0,0,0,0.2);
              color: white;
            }

            .floating-menu-btn i {
              font-size: 18px;
            }

            .floating-menu-dropdown {
              position: absolute;
              right: 0;
              top: 100%;
              background: white;
              border-radius: 15px;
              box-shadow: 0 10px 30px rgba(0,0,0,0.15);
              min-width: 250px;
              opacity: 0;
              visibility: hidden;
              transform: translateY(-10px);
              transition: all 0.3s ease;
              margin-top: 10px;
            }

            .floating-menu-dropdown.show {
              opacity: 1;
              visibility: visible;
              transform: translateY(0);
            }

            .dropdown-header {
              background: linear-gradient(45deg, #667eea, #764ba2);
              color: white;
              padding: 15px 20px;
              border-radius: 15px 15px 0 0;
              text-align: center;
            }

            .dropdown-header h6 {
              margin: 0;
              font-weight: 600;
              font-size: 16px;
            }

            .dropdown-content {
              padding: 15px;
            }

            .dropdown-btn {
              width: 100%;
              padding: 12px 15px;
              margin: 5px 0;
              border: none;
              border-radius: 10px;
              font-weight: 600;
              transition: all 0.3s ease;
              display: flex;
              align-items: center;
              gap: 10px;
              cursor: pointer;
              font-size: 14px;
            }

            .dropdown-btn:hover {
              transform: translateX(5px);
            }

            .dropdown-btn.btn-save {
              background: linear-gradient(45deg, #28a745, #20c997);
              color: white;
            }

            .dropdown-btn.btn-save:hover {
              background: linear-gradient(45deg, #218838, #1ea085);
              color: white;
            }

            .dropdown-btn.btn-load {
              background: linear-gradient(45deg, #007bff, #0056b3);
              color: white;
            }

            .dropdown-btn.btn-load:hover {
              background: linear-gradient(45deg, #0056b3, #004085);
              color: white;
            }

            .dropdown-btn.btn-clear {
              background: linear-gradient(45deg, #dc3545, #c82333);
              color: white;
            }

            .dropdown-btn.btn-clear:hover {
              background: linear-gradient(45deg, #c82333, #a71e2a);
              color: white;
            }

            /* Responsividade para o menu flutuante */
            @media (max-width: 768px) {
              .floating-menu {
                right: 10px;
              }
              
              .floating-menu-btn {
                min-width: 60px;
                padding: 15px;
              }
              
              .floating-menu-btn span {
                display: none;
              }
              
              .floating-menu-dropdown {
                min-width: 200px;
                right: -70px;
              }
            }
  </style>
</head>
<body>
  <div class="main-container">
    <div class="page-header">
      <h2><i class="fas fa-paint-brush"></i> Pagebuilder Push Ecommerce</h2>
      <p>Construa sua descrição visualmente com estrutura e indicador</p>
    </div>


    
    <div class="container-controls">
      <div style="margin-bottom: 15px;">
        <button onclick="addContainer(1)" class="btn-container">
          <i class="fas fa-columns"></i> Container 1 Coluna
        </button>
        <button onclick="addContainer(2)" class="btn-container">
          <i class="fas fa-columns"></i> Container 2 Colunas
        </button>
        <button onclick="addContainer(3)" class="btn-container">
          <i class="fas fa-columns"></i> Container 3 Colunas
        </button>
        <button onclick="addContainer(4)" class="btn-container">
          <i class="fas fa-columns"></i> Container 4 Colunas
        </button>
        <button onclick="addContainer(5)" class="btn-container">
          <i class="fas fa-columns"></i> Container 5 Colunas
        </button>
      </div>
      <div>
        <button onclick="toggleAllContainers()" class="btn-container" style="background: linear-gradient(45deg, #ffc107, #ff8c00);">
          <i class="fas fa-compress-alt"></i> Recolher/Expandir Todos
        </button>
        <button onclick="expandAllContainers()" class="btn-container" style="background: linear-gradient(45deg, #28a745, #20c997);">
          <i class="fas fa-expand-alt"></i> Expandir Todos
        </button>
      </div>
    </div>
    
    <div id="builder"></div>
    
    <div class="text-center">
      <button onclick="generateCode()" class="btn-generate">
        <i class="fas fa-code"></i> Gerar HTML
      </button>
      <button class="btn-copiar" onclick="copyCode()" type="button">
        <i class="fas fa-copy"></i> Copiar código
      </button>
    </div>
    
    <div class="preview">
      <h3><i class="fas fa-eye"></i> Prévia</h3>
      <div id="preview"></div>
    </div>
    
    <h3><i class="fas fa-code"></i> Código HTML</h3>
    <textarea id="output" rows="18" readonly class="form-control"></textarea>
    
    <!-- Área para colar código anterior para reconstruir -->
    <div class="paste-area">
      <h4><i class="fas fa-paste"></i> Colar código anterior para reconstruir</h4>
      <textarea id="pasteCode" placeholder="Cole aqui o código HTML gerado anteriormente..."></textarea>
      <button onclick="parsePastedCode()" class="btn-copiar">
        <i class="fas fa-magic"></i> Reconstruir a partir do código
      </button>
    </div>

    <!-- Menu flutuante de gerenciamento de dados -->
    <div class="floating-menu">
      <button class="floating-menu-btn" onclick="toggleDataMenu()">
        <i class="fas fa-cog"></i>
        <span>Gerenciar Dados</span>
      </button>
      
      <div class="floating-menu-dropdown" id="dataMenuDropdown">
        <div class="dropdown-header">
          <h6><i class="fas fa-save"></i> Gerenciar Dados</h6>
        </div>
        <div class="dropdown-content">
          <button onclick="saveToLocalStorage()" class="dropdown-btn btn-save">
            <i class="fas fa-save"></i> Salvar Projeto
          </button>
          <button onclick="loadFromLocalStorage()" class="dropdown-btn btn-load">
            <i class="fas fa-folder-open"></i> Carregar Projeto
          </button>
          <button onclick="clearLocalStorage()" class="dropdown-btn btn-clear">
            <i class="fas fa-trash"></i> Limpar Dados
          </button>
        </div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://cdn.quilljs.com/2.0.0-dev.2/quill.js"></script>
  <script>
    // Suprimir avisos de depreciação do Quill
    const originalWarn = console.warn;
    console.warn = function(...args) {
      if (args[0] && typeof args[0] === 'string' && args[0].includes('DOMNodeInserted')) {
        return; // Suprimir avisos de depreciação do Quill
      }
      originalWarn.apply(console, args);
    };
    
    let containers = [];
    let quillInstances = {};
    let draggedElement = null;
    let draggedContainer = null;
    let containerCollapseStates = [];

    // Classes para colunas responsivas e espaçamento
    const colClasses = {
      1: ['col-12 mb-4'],
      2: ['col-12 col-md-6 mb-4', 'col-12 col-md-6 mb-4'],
      3: ['col-12 col-md-4 mb-4', 'col-12 col-md-4 mb-4', 'col-12 col-md-4 mb-4'],
      4: ['col-12 col-md-3 mb-4', 'col-12 col-md-3 mb-4', 'col-12 col-md-3 mb-4', 'col-12 col-md-3 mb-4'],
      5: ['col-12 col-md mb-4', 'col-12 col-md mb-4', 'col-12 col-md mb-4', 'col-12 col-md mb-4', 'col-12 col-md mb-4']
    };

    // Classes específicas para cada tipo de container
    const containerClasses = {
      1: 'push-1-col',
      2: 'push-2-cols', 
      3: 'push-3-cols',
      4: 'push-4-cols',
      5: 'push-5-cols'
    };

    function addContainer(cols) {
      const container = {
        cols,
        name: `Container ${cols} Colunas`,
        blocks: Array.from({ length: cols }, () => [])
      };
      containers.push(container);
      // Novo container começa expandido
      containerCollapseStates.push('expanded');
      renderBuilder();
    }

    function addBlock(containerIdx, colIdx, type) {
      if (type === 'html') {
        containers[containerIdx].blocks[colIdx].push({
          type,
          content: '<h3>Título</h3><p>Texto com <strong>negrito</strong>, <em>itálico</em> e listas:</p><ul><li>Item 1</li><li>Item 2</li></ul>'
        });
      } else if (type === 'image') {
        containers[containerIdx].blocks[colIdx].push({
          type,
          content: 'https://via.placeholder.com/400x300?text=Imagem',
          link: '' // Campo para link da imagem
        });
      } else {
        // Sempre usar HTML avançado para texto
        containers[containerIdx].blocks[colIdx].push({
          type: 'html',
          content: '<p>Digite seu texto aqui...</p>'
        });
      }
      renderBuilder();
    }

    function updateBlock(containerIdx, colIdx, blockIdx, value) {
      containers[containerIdx].blocks[colIdx][blockIdx].content = value;
      renderPreview();
    }

    function updateImageLink(containerIdx, colIdx, blockIdx, value) {
      containers[containerIdx].blocks[colIdx][blockIdx].link = value;
      renderPreview();
    }

    function removeBlock(containerIdx, colIdx, blockIdx) {
      containers[containerIdx].blocks[colIdx].splice(blockIdx, 1);
      renderBuilder();
    }

    function removeContainer(idx) {
      containers.splice(idx, 1);
      // Remover também o estado de colapso
      containerCollapseStates.splice(idx, 1);
      renderBuilder();
    }

    function updateContainerName(idx, newName) {
      if (containers[idx]) {
        containers[idx].name = newName;
        renderPreview();
      }
    }

    // Função para duplicar container
    function duplicateContainer(idx) {
      const container = containers[idx];
      const duplicatedContainer = {
        cols: container.cols,
        name: `${container.name || `Container ${container.cols} Colunas`} (Cópia)`,
        blocks: container.blocks.map(col => 
          col.map(block => ({
            ...block,
            content: block.content // Duplicar o conteúdo
          }))
        )
      };
      
      // Inserir o container duplicado logo após o original
      containers.splice(idx + 1, 0, duplicatedContainer);
      
      // O container duplicado começa expandido
      containerCollapseStates.splice(idx + 1, 0, 'expanded');
      
      renderBuilder();
    }

    // Função para mover container para cima
    function moveContainerUp(idx) {
      if (idx > 0) {
        // Preservar estados de colapso
        const tempContainer = containers[idx];
        const tempCollapseState = containerCollapseStates[idx];
        
        containers[idx] = containers[idx - 1];
        containers[idx - 1] = tempContainer;
        
        containerCollapseStates[idx] = containerCollapseStates[idx - 1];
        containerCollapseStates[idx - 1] = tempCollapseState;
        
        renderBuilder();
      }
    }

    // Função para mover container para baixo
    function moveContainerDown(idx) {
      if (idx < containers.length - 1) {
        // Preservar estados de colapso
        const tempContainer = containers[idx];
        const tempCollapseState = containerCollapseStates[idx];
        
        containers[idx] = containers[idx + 1];
        containers[idx + 1] = tempContainer;
        
        containerCollapseStates[idx] = containerCollapseStates[idx + 1];
        containerCollapseStates[idx + 1] = tempCollapseState;
        
        renderBuilder();
      }
    }



    // Função para recolher/expandir container (accordion)
    function toggleContainerCollapse(idx) {
      const content = document.getElementById(`container-content-${idx}`);
      const button = document.getElementById(`collapse-btn-${idx}`);
      const containerItem = document.querySelector(`[data-container-id="${idx}"]`);
      const icon = button.querySelector('i');
      
      if (content.classList.contains('expanded')) {
        content.classList.remove('expanded');
        content.classList.add('collapsed');
        containerItem.classList.add('collapsed');
        icon.className = 'fas fa-chevron-down';
        button.innerHTML = '<i class="fas fa-chevron-down"></i> Expandir';
        // Armazenar estado de colapso
        containerCollapseStates[idx] = 'collapsed';
      } else {
        content.classList.remove('collapsed');
        content.classList.add('expanded');
        containerItem.classList.remove('collapsed');
        icon.className = 'fas fa-chevron-up';
        button.innerHTML = '<i class="fas fa-chevron-up"></i> Recolher';
        // Armazenar estado de colapso
        containerCollapseStates[idx] = 'expanded';
      }
    }

    // Função para recolher/expandir todos os containers
    function toggleAllContainers() {
      const allExpanded = Array.from(document.querySelectorAll('.container-content')).every(
        content => content.classList.contains('expanded')
      );
      
      if (allExpanded) {
        // Recolher todos
        containers.forEach((_, idx) => {
          const content = document.getElementById(`container-content-${idx}`);
          const button = document.getElementById(`collapse-btn-${idx}`);
          const containerItem = document.querySelector(`[data-container-id="${idx}"]`);
          if (content && button) {
            content.classList.remove('expanded');
            content.classList.add('collapsed');
            if (containerItem) containerItem.classList.add('collapsed');
            button.innerHTML = '<i class="fas fa-chevron-down"></i> Expandir';
            containerCollapseStates[idx] = 'collapsed';
          }
        });
      } else {
        // Expandir todos
        expandAllContainers();
      }
    }

    // Função para expandir todos os containers
    function expandAllContainers() {
      containers.forEach((_, idx) => {
        const content = document.getElementById(`container-content-${idx}`);
        const button = document.getElementById(`collapse-btn-${idx}`);
        const containerItem = document.querySelector(`[data-container-id="${idx}"]`);
        if (content && button) {
          content.classList.remove('collapsed');
          content.classList.add('expanded');
          if (containerItem) containerItem.classList.remove('collapsed');
          button.innerHTML = '<i class="fas fa-chevron-up"></i> Recolher';
          containerCollapseStates[idx] = 'expanded';
        }
      });
    }

    // Função para colar código anterior
    function parsePastedCode() {
      const pastedCode = document.getElementById('pasteCode').value.trim();
      if (!pastedCode) {
        alert('Por favor, cole o código HTML primeiro!');
        return;
      }

      try {
        // Decodificar entidades HTML
        const decodedCode = pastedCode
          .replace(/&amp;/g, '&')
          .replace(/&lt;/g, '<')
          .replace(/&gt;/g, '>')
          .replace(/&quot;/g, '"')
          .replace(/&#39;/g, "'")
          .replace(/&nbsp;/g, ' ')
          .replace(/&iacute;/g, 'í')
          .replace(/&ccedil;/g, 'ç')
          .replace(/&ecirc;/g, 'ê')
          .replace(/&atilde;/g, 'ã')
          .replace(/&oacute;/g, 'ó')
          .replace(/&aacute;/g, 'á')
          .replace(/&eacute;/g, 'é')
          .replace(/&uacute;/g, 'ú')
          .replace(/&Aacute;/g, 'Á')
          .replace(/&Eacute;/g, 'É')
          .replace(/&Iacute;/g, 'Í')
          .replace(/&Oacute;/g, 'Ó')
          .replace(/&Uacute;/g, 'Ú')
          .replace(/&Ccedil;/g, 'Ç')
          .replace(/&Atilde;/g, 'Ã')
          .replace(/&Ecirc;/g, 'Ê')
          .replace(/&Ocirc;/g, 'Ô')
          .replace(/&mdash;/g, '—')
          .replace(/&reg;/g, '®');

        // Criar um parser temporário
        const parser = new DOMParser();
        const doc = parser.parseFromString(decodedCode, 'text/html');
        
        // Limpar containers existentes
        containers = [];
        
        // Procurar por containers
        const containerRows = doc.querySelectorAll('.page-builder-push .row');
        
        containerRows.forEach(row => {
          // Determinar número de colunas
          const cols = row.children.length;
          if (cols >= 1 && cols <= 5) {
            const container = {
              cols,
              name: `Container ${cols} Colunas`,
              blocks: Array.from({ length: cols }, () => [])
            };
            
            // Processar cada coluna
            Array.from(row.children).forEach((col, colIdx) => {
              let hasImage = false;
              let textContent = '';
              
              // Processar elementos dentro da coluna
              Array.from(col.children).forEach(element => {
                if (element.tagName === 'IMG') {
                  // Verificar se a imagem está dentro de um link
                  const parentLink = element.closest('a');
                  const imageLink = parentLink ? parentLink.href : '';
                  
                  // Adicionar imagem como bloco separado
                  container.blocks[colIdx].push({
                    type: 'image',
                    content: element.src,
                    link: imageLink // Adicionar link da imagem
                  });
                  hasImage = true;
                } else if (element.innerHTML.trim()) {
                  // Acumular todo o conteúdo de texto em um único bloco HTML
                  textContent += element.outerHTML;
                }
              });
              
              // Adicionar bloco de texto se houver conteúdo
              if (textContent.trim()) {
                container.blocks[colIdx].push({
                  type: 'html',
                  content: textContent
                });
              }
            });
            
            containers.push(container);
          }
        });
        
        renderBuilder();
        alert('Código reconstruído com sucesso!');
        
      } catch (error) {
        alert('Erro ao processar o código. Verifique se o formato está correto.');
        console.error(error);
      }
    }

    function renderBuilder() {
      const builder = document.getElementById('builder');
      builder.innerHTML = '';
      quillInstances = {}; // Reset
      
      containers.forEach((container, cIdx) => {
        let html = `<div class="container-item ${(containerCollapseStates[cIdx] || 'expanded') === 'collapsed' ? 'collapsed' : ''}" data-container-id="${cIdx}">
          <div class="container-header">
            <h5 class="container-title">
              <i class="fas fa-grip-vertical" style="margin-right: 8px; color: #6c757d;"></i>
              Container ${container.cols} Colunas
              <span class="container-name">
                <input type="text" 
                       class="container-name-input" 
                       value="${container.name || `Container ${container.cols} Colunas`}" 
                       onchange="updateContainerName(${cIdx}, this.value)" 
                       onblur="updateContainerName(${cIdx}, this.value)"
                       placeholder="Nome do container">
              </span>
            </h5>
            <div class="container-actions">
              <button type="button" onclick="toggleContainerCollapse(${cIdx})" class="btn-collapse" id="collapse-btn-${cIdx}">
                <i class="fas fa-${(containerCollapseStates[cIdx] || 'expanded') === 'collapsed' ? 'chevron-down' : 'chevron-up'}"></i> ${(containerCollapseStates[cIdx] || 'expanded') === 'collapsed' ? 'Expandir' : 'Recolher'}
              </button>
              <button type="button" onclick="duplicateContainer(${cIdx})" class="btn-duplicate">
                <i class="fas fa-copy"></i> Duplicar
              </button>
              <button type="button" onclick="moveContainerUp(${cIdx})" class="btn-move-up" ${cIdx === 0 ? 'disabled' : ''}>
                <i class="fas fa-arrow-up"></i> Subir
              </button>
              <button type="button" onclick="moveContainerDown(${cIdx})" class="btn-move-down" ${cIdx === containers.length - 1 ? 'disabled' : ''}>
                <i class="fas fa-arrow-down"></i> Descer
              </button>
              <button type="button" onclick="addColumnToContainer(${cIdx})" class="btn-add-col" ${container.cols >= 5 ? 'disabled' : ''}>
                <i class="fas fa-plus"></i> + Coluna
              </button>
              <button type="button" onclick="removeColumnFromContainer(${cIdx})" class="btn-remove-col" ${container.cols <= 1 ? 'disabled' : ''}>
                <i class="fas fa-minus"></i> - Coluna
              </button>
              <button type="button" onclick="removeContainer(${cIdx})" class="btn-remove">
                <i class="fas fa-times"></i> Remover
              </button>
            </div>
          </div>
          <div class="container-content ${containerCollapseStates[cIdx] || 'expanded'}" id="container-content-${cIdx}">
            <div class="row ${containerClasses[container.cols]}">`;
        container.blocks.forEach((col, colIdx) => {
          html += `<div class="${colClasses[container.cols][colIdx]} col" data-container="${cIdx}" data-col="${colIdx}">`;
          col.forEach((block, bIdx) => {
            html += `<div class="bloco" data-container="${cIdx}" data-col="${colIdx}" data-block="${bIdx}">
              <div class="drag-handle" draggable="true">⋮⋮ Arrastar</div>`;
            if (block.type === 'html') {
              const quillId = `quill-${cIdx}-${colIdx}-${bIdx}`;
              html += `<label class="form-label">Texto avançado (editor visual):</label>
                <div id="${quillId}" class="quill-editor"></div>
                <div class="table-controls">
                  <button id="insert-table-${quillId}" class="insert"><i class="fas fa-table"></i> Inserir Tabela</button>
                  <button id="insert-row-above-${quillId}" class="add"><i class="fas fa-plus"></i> Adicionar Linha Acima</button>
                  <button id="insert-row-below-${quillId}" class="add"><i class="fas fa-plus"></i> Adicionar Linha Abaixo</button>
                  <button id="insert-column-left-${quillId}" class="add"><i class="fas fa-plus"></i> Adicionar Coluna Esquerda</button>
                  <button id="insert-column-right-${quillId}" class="add"><i class="fas fa-plus"></i> Adicionar Coluna Direita</button>
                  <button id="delete-row-${quillId}" class="delete"><i class="fas fa-minus"></i> Remover Linha</button>
                  <button id="delete-column-${quillId}" class="delete"><i class="fas fa-minus"></i> Remover Coluna</button>
                  <button id="delete-table-${quillId}" class="delete"><i class="fas fa-trash"></i> Remover Tabela</button>
                </div>`;
            }
            if (block.type === 'image') {
              html += `<div class="form-group">
                <label class="form-label">URL da imagem:</label>
                <input type="text" value="${block.content}" onchange="updateBlock(${cIdx},${colIdx},${bIdx}, this.value)" oninput="updateBlock(${cIdx},${colIdx},${bIdx}, this.value)" class="form-control">
                <label class="form-label">Link da imagem (opcional):</label>
                <input type="text" value="${block.link || ''}" onchange="updateImageLink(${cIdx},${colIdx},${bIdx}, this.value)" oninput="updateImageLink(${cIdx},${colIdx},${bIdx}, this.value)" class="form-control">
                <img src="${block.content}" alt="Prévia da imagem" class="img-fluid" />
              </div>`;
            }
            html += `<button type="button" onclick="removeBlock(${cIdx},${colIdx},${bIdx})" class="btn-remove-block">
              <i class="fas fa-times"></i> Remover
            </button>`;
            html += `</div>`;
          });
          html += `
            <div class="text-center">
              <button type="button" onclick="addBlock(${cIdx},${colIdx},'html')" class="btn-add">
                <i class="fas fa-plus-circle"></i> Texto avançado (editor visual)
              </button>
              <button type="button" onclick="addBlock(${cIdx},${colIdx},'image')" class="btn-add">
                <i class="fas fa-plus-circle"></i> Imagem
              </button>
            </div>
          `;
          html += `</div>`;
        });
        html += `</div></div>`;
        builder.innerHTML += html;
      });
      
      // Configurar drag and drop após renderizar
      setTimeout(() => {
        initQuillEditors();
        initDragAndDrop();
        initContainerDragAndDrop();
      }, 300);
      
      renderPreview();
    }

    function initDragAndDrop() {
      // Configurar drag handles
      document.querySelectorAll('.drag-handle').forEach(handle => {
        const bloco = handle.closest('.bloco');
        const containerIdx = parseInt(bloco.dataset.container);
        const colIdx = parseInt(bloco.dataset.col);
        const blockIdx = parseInt(bloco.dataset.block);
        
        handle.addEventListener('dragstart', (e) => {
          e.stopPropagation();
          draggedElement = { containerIdx, colIdx, blockIdx };
          bloco.classList.add('dragging');
          e.dataTransfer.effectAllowed = 'move';
          e.dataTransfer.setData('text/plain', ''); // Necessário para Firefox
        });
        
        handle.addEventListener('dragend', (e) => {
          e.stopPropagation();
          bloco.classList.remove('dragging');
          draggedElement = null;
        });
      });
      
      // Configurar zonas de drop nas colunas
      document.querySelectorAll('.col').forEach(col => {
        const containerIdx = parseInt(col.dataset.container);
        const colIdx = parseInt(col.dataset.col);
        
        col.addEventListener('dragover', (e) => {
          e.preventDefault();
          e.stopPropagation();
          col.classList.add('drag-over');
        });
        
        col.addEventListener('dragleave', (e) => {
          e.preventDefault();
          e.stopPropagation();
          if (!col.contains(e.relatedTarget)) {
            col.classList.remove('drag-over');
          }
        });
        
        col.addEventListener('drop', (e) => {
          e.preventDefault();
          e.stopPropagation();
          col.classList.remove('drag-over');
          
          if (draggedElement) {
            const { containerIdx: sourceContainer, colIdx: sourceCol, blockIdx } = draggedElement;
            
            // Verificar se não está tentando mover para o mesmo local
            if (sourceContainer === containerIdx && sourceCol === colIdx) {
              return;
            }
            
            // Verificar se os índices são válidos
            if (sourceContainer >= 0 && sourceCol >= 0 && blockIdx >= 0 && 
                containerIdx >= 0 && colIdx >= 0 &&
                containers[sourceContainer] && 
                containers[sourceContainer].blocks[sourceCol] &&
                containers[sourceContainer].blocks[sourceCol][blockIdx] &&
                containers[containerIdx] &&
                containers[containerIdx].blocks[colIdx]) {
              
              // Mover o bloco
              const block = containers[sourceContainer].blocks[sourceCol][blockIdx];
              containers[sourceContainer].blocks[sourceCol].splice(blockIdx, 1);
              containers[containerIdx].blocks[colIdx].push(block);
              
              renderBuilder();
            }
          }
        });
      });
    }

    function initContainerDragAndDrop() {
      // Configurar drag handles para containers
      document.querySelectorAll('.container-header').forEach(header => {
        const containerItem = header.closest('.container-item');
        const containerId = parseInt(containerItem.dataset.containerId);
        
        header.style.cursor = 'move';
        header.setAttribute('draggable', 'true');
        
        header.addEventListener('dragstart', (e) => {
          e.stopPropagation();
          draggedContainer = containerId;
          containerItem.classList.add('dragging');
          e.dataTransfer.effectAllowed = 'move';
          e.dataTransfer.setData('text/plain', '');
        });
        
        header.addEventListener('dragend', (e) => {
          e.stopPropagation();
          containerItem.classList.remove('dragging');
          draggedContainer = null;
        });
      });
      
      // Configurar zonas de drop entre containers
      const builder = document.getElementById('builder');
      
      builder.addEventListener('dragover', (e) => {
        e.preventDefault();
        e.stopPropagation();
        
        const containerItem = e.target.closest('.container-item');
        if (containerItem && draggedContainer !== null) {
          const rect = containerItem.getBoundingClientRect();
          const midY = rect.top + rect.height / 2;
          
          // Remover todas as zonas de drop existentes
          document.querySelectorAll('.container-drop-zone').forEach(zone => zone.remove());
          
          if (e.clientY < midY) {
            // Inserir zona de drop antes do container
            const dropZone = document.createElement('div');
            dropZone.className = 'container-drop-zone drag-over';
            containerItem.parentNode.insertBefore(dropZone, containerItem);
          } else {
            // Inserir zona de drop após o container
            const dropZone = document.createElement('div');
            dropZone.className = 'container-drop-zone drag-over';
            containerItem.parentNode.insertBefore(dropZone, containerItem.nextSibling);
          }
        }
      });
      
      builder.addEventListener('dragleave', (e) => {
        e.preventDefault();
        e.stopPropagation();
        
        if (!e.target.closest('.container-item') && !e.target.closest('.container-drop-zone')) {
          document.querySelectorAll('.container-drop-zone').forEach(zone => zone.remove());
        }
      });
      
      builder.addEventListener('drop', (e) => {
        e.preventDefault();
        e.stopPropagation();
        
        const dropZone = e.target.closest('.container-drop-zone');
        if (dropZone && draggedContainer !== null) {
          const targetContainer = dropZone.nextElementSibling || dropZone.previousElementSibling;
          if (targetContainer && targetContainer.classList.contains('container-item')) {
            const targetId = parseInt(targetContainer.dataset.containerId);
            
            if (draggedContainer !== targetId) {
              // Mover o container preservando o estado de colapso
              const draggedContainerData = containers[draggedContainer];
              const draggedCollapseState = containerCollapseStates[draggedContainer];
              
              containers.splice(draggedContainer, 1);
              containerCollapseStates.splice(draggedContainer, 1);
              
              const newIndex = dropZone.nextElementSibling ? targetId : targetId + 1;
              containers.splice(newIndex, 0, draggedContainerData);
              containerCollapseStates.splice(newIndex, 0, draggedCollapseState);
              
              renderBuilder();
            }
          }
        }
        
        // Limpar zonas de drop
        document.querySelectorAll('.container-drop-zone').forEach(zone => zone.remove());
      });
    }

    function initQuillEditors() {
      // Limpar instâncias existentes
      Object.keys(quillInstances).forEach(id => {
        if (quillInstances[id]) {
          quillInstances[id].destroy();
        }
      });
      quillInstances = {};
      
      document.querySelectorAll('.quill-editor').forEach((div, index) => {
        const [cIdx, colIdx, bIdx] = div.id.split('-').slice(1).map(Number);
        const block = containers[cIdx].blocks[colIdx][bIdx];
        
        if (block && block.type === 'html') {
          const quill = new Quill(`#${div.id}`, {
            theme: 'snow',
            modules: {
              toolbar: {
                container: [
                  [{ 'header': [1, 2, 3, false] }],
                  ['bold', 'italic', 'underline', 'strike'],
                  [{ 'color': [] }, { 'background': [] }],
                  [{ 'align': [] }],
                  [{ 'list': 'ordered'}, { 'list': 'bullet' }],
                  [{ 'indent': '-1'}, { 'indent': '+1' }],
                  ['link', 'image', 'code-block'],
                  ['clean']
                ]
              }
            }
          });
          
          // Carregar conteúdo no editor
          quill.root.innerHTML = block.content;
          
          quill.on('text-change', function() {
            block.content = quill.root.innerHTML;
            renderPreview();
          });
          
          quillInstances[div.id] = quill;
          
          // Configurar botões de tabela
          setupTableButtons(div.id, quill);
        }
      });
    }

    function setupTableButtons(quillId, quill) {
      console.log('Configurando botões de tabela para:', quillId);
      
      // Tentar obter o módulo de tabela
      let tableModule = null;
      try {
        tableModule = quill.getModule('table');
        console.log('Módulo de tabela encontrado:', tableModule);
      } catch (error) {
        console.log('Módulo de tabela não disponível, usando fallback HTML');
      }
      
      // Funções para manipular tabelas
      const tableActions = {
        insertTable: () => {
          console.log('Inserindo tabela...');
          if (tableModule && typeof tableModule.insertTable === 'function') {
            tableModule.insertTable(2, 2);
          } else {
            insertTableHTML(quill);
          }
        },
        
        insertRowAbove: () => {
          console.log('Adicionando linha acima...');
          if (tableModule && typeof tableModule.insertRowAbove === 'function') {
            tableModule.insertRowAbove();
          } else {
            insertRowAbove(quill);
          }
        },
        
        insertRowBelow: () => {
          console.log('Adicionando linha abaixo...');
          if (tableModule && typeof tableModule.insertRowBelow === 'function') {
            tableModule.insertRowBelow();
          } else {
            insertRowBelow(quill);
          }
        },
        
        insertColumnLeft: () => {
          console.log('Adicionando coluna esquerda...');
          if (tableModule && typeof tableModule.insertColumnLeft === 'function') {
            tableModule.insertColumnLeft();
          } else {
            insertColumnLeft(quill);
          }
        },
        
        insertColumnRight: () => {
          console.log('Adicionando coluna direita...');
          if (tableModule && typeof tableModule.insertColumnRight === 'function') {
            tableModule.insertColumnRight();
          } else {
            insertColumnRight(quill);
          }
        },
        
        deleteRow: () => {
          console.log('Removendo linha...');
          if (tableModule && typeof tableModule.deleteRow === 'function') {
            tableModule.deleteRow();
          } else {
            deleteRow(quill);
          }
        },
        
        deleteColumn: () => {
          console.log('Removendo coluna...');
          if (tableModule && typeof tableModule.deleteColumn === 'function') {
            tableModule.deleteColumn();
          } else {
            deleteColumn(quill);
          }
        },
        
        deleteTable: () => {
          console.log('Removendo tabela...');
          if (tableModule && typeof tableModule.deleteTable === 'function') {
            tableModule.deleteTable();
          } else {
            deleteTable(quill);
          }
        }
      };
      
      // Configurar botões de tabela
      const buttons = [
        { id: 'insert-table', action: tableActions.insertTable },
        { id: 'insert-row-above', action: tableActions.insertRowAbove },
        { id: 'insert-row-below', action: tableActions.insertRowBelow },
        { id: 'insert-column-left', action: tableActions.insertColumnLeft },
        { id: 'insert-column-right', action: tableActions.insertColumnRight },
        { id: 'delete-row', action: tableActions.deleteRow },
        { id: 'delete-column', action: tableActions.deleteColumn },
        { id: 'delete-table', action: tableActions.deleteTable }
      ];
      
      buttons.forEach(button => {
        const btnElement = document.getElementById(`${button.id}-${quillId}`);
        if (btnElement) {
          console.log('Configurando botão:', button.id, 'para elemento:', btnElement);
          btnElement.addEventListener('click', (e) => {
            e.preventDefault();
            e.stopPropagation();
            button.action();
          });
        } else {
          console.log('Botão não encontrado:', `${button.id}-${quillId}`);
        }
      });
    }

         function insertTableHTML(quill) {
       console.log('Inserindo tabela HTML...');
       
       // Criar HTML da tabela como string - sem estilos inline
       const tableHTML = `
         <table>
           <tr>
             <td>Célula 1</td>
             <td>Célula 2</td>
           </tr>
           <tr>
             <td>Célula 3</td>
             <td>Célula 4</td>
           </tr>
         </table>
       `;
       
       const range = quill.getSelection();
       if (range) {
         console.log('Inserindo tabela na posição:', range.index);
         
         // Inserir quebra de linha antes da tabela
         quill.insertText(range.index, '\n');
         
         // Inserir a tabela como HTML
         quill.clipboard.dangerouslyPasteHTML(range.index + 1, tableHTML);
         
         // Forçar atualização do Quill
         quill.update();
       } else {
         console.log('Nenhuma seleção encontrada, inserindo no final');
         quill.insertText(quill.getLength(), '\n');
         quill.clipboard.dangerouslyPasteHTML(quill.getLength(), tableHTML);
         quill.update();
       }
     }

     // Funções de fallback para manipulação de tabelas
     function findCurrentTable(quill) {
       console.log('Procurando tabela atual...');
       
       // Primeiro, tentar encontrar qualquer tabela no editor
       const tables = quill.root.querySelectorAll('table');
       console.log('Tabelas encontradas no editor:', tables.length);
       
       if (tables.length === 0) {
         console.log('Nenhuma tabela encontrada no editor');
         return null;
       }
       
       // Se há apenas uma tabela, usar ela
       if (tables.length === 1) {
         console.log('Usando única tabela encontrada');
         return tables[0];
       }
       
       // Se há múltiplas tabelas, tentar encontrar a mais próxima do cursor
       const range = quill.getSelection();
       if (!range) {
         console.log('Nenhuma seleção ativa, usando primeira tabela');
         return tables[0];
       }
       
       // Tentar encontrar a tabela através do elemento atual
       const [leaf, offset] = quill.getLeaf(range.index);
       let table = null;
       
       // Verificar se leaf.domNode existe e é um elemento DOM
       if (leaf && leaf.domNode && leaf.domNode.nodeType === Node.ELEMENT_NODE) {
         table = leaf.domNode.closest('table');
         if (table) {
           console.log('Tabela encontrada através do elemento atual');
           return table;
         }
       }
       
       // Tentar encontrar a tabela mais próxima baseada na posição do cursor
       let closestTable = null;
       let minDistance = Infinity;
       
       tables.forEach(table => {
         const rect = table.getBoundingClientRect();
         const editorRect = quill.root.getBoundingClientRect();
         const tableTop = rect.top - editorRect.top;
         const cursorTop = range.index * 20; // Aproximação da posição do cursor
         const distance = Math.abs(tableTop - cursorTop);
         
         if (distance < minDistance) {
           minDistance = distance;
           closestTable = table;
         }
       });
       
       if (closestTable) {
         console.log('Tabela mais próxima encontrada');
         return closestTable;
       }
       
       // Se não encontrou, usar a primeira tabela
       console.log('Usando primeira tabela como fallback');
       return tables[0];
     }
     
     function findCurrentRow(quill) {
       console.log('Procurando linha atual...');
       
       // Primeiro, tentar encontrar qualquer linha na tabela atual
       const table = findCurrentTable(quill);
       if (!table) {
         console.log('Nenhuma tabela encontrada para procurar linha');
         return null;
       }
       
       const rows = table.querySelectorAll('tr');
       console.log('Linhas encontradas na tabela:', rows.length);
       
       if (rows.length === 0) {
         console.log('Nenhuma linha encontrada na tabela');
         return null;
       }
       
       // Se há apenas uma linha, usar ela
       if (rows.length === 1) {
         console.log('Usando única linha encontrada');
         return rows[0];
       }
       
       // Se há múltiplas linhas, tentar encontrar a mais próxima do cursor
       const range = quill.getSelection();
       if (!range) {
         console.log('Nenhuma seleção ativa, usando primeira linha');
         return rows[0];
       }
       
       const [leaf, offset] = quill.getLeaf(range.index);
       let row = null;
       
       if (leaf && leaf.domNode && leaf.domNode.nodeType === Node.ELEMENT_NODE) {
         row = leaf.domNode.closest('tr');
         if (row && table.contains(row)) {
           console.log('Linha encontrada através do elemento atual');
           return row;
         }
       }
       
       // Se não encontrou, usar a primeira linha
       console.log('Usando primeira linha como fallback');
       return rows[0];
     }
     
     function findCurrentCell(quill) {
       const range = quill.getSelection();
       if (!range) return null;
       
       const [leaf, offset] = quill.getLeaf(range.index);
       let cell = null;
       
       if (leaf && leaf.domNode && leaf.domNode.nodeType === Node.ELEMENT_NODE) {
         cell = leaf.domNode.closest('td, th');
       }
       
       if (!cell) {
         const table = findCurrentTable(quill);
         if (table) {
           cell = table.querySelector('td, th');
         }
       }
       
       return cell;
     }

     function insertRowAbove(quill) {
       console.log('Tentando inserir linha acima...');
       const table = findCurrentTable(quill);
       const currentRow = findCurrentRow(quill);
       
       if (table && currentRow) {
         console.log('Tabela e linha encontradas, inserindo nova linha...');
         const newRow = document.createElement('tr');
         const colCount = currentRow.cells.length;
         
         for (let i = 0; i < colCount; i++) {
           const cell = document.createElement('td');
           cell.innerHTML = 'Nova célula';
           newRow.appendChild(cell);
         }
         
         currentRow.parentNode.insertBefore(newRow, currentRow);
         
         // Forçar atualização do Quill
         quill.update();
         console.log('Linha inserida com sucesso');
       } else {
         console.log('Tabela ou linha não encontradas');
         // Se não encontrou, tentar inserir na primeira tabela
         const tables = quill.root.querySelectorAll('table');
         if (tables.length > 0) {
           const table = tables[0];
           const firstRow = table.querySelector('tr');
           if (firstRow) {
             console.log('Inserindo linha na primeira tabela...');
             const newRow = document.createElement('tr');
             const colCount = firstRow.cells.length;
             
             for (let i = 0; i < colCount; i++) {
               const cell = document.createElement('td');
               cell.innerHTML = 'Nova célula';
               newRow.appendChild(cell);
             }
             
             table.insertBefore(newRow, firstRow);
             quill.update();
             console.log('Linha inserida na primeira tabela');
           }
         }
       }
     }

     function insertRowBelow(quill) {
       console.log('Tentando inserir linha abaixo...');
       const table = findCurrentTable(quill);
       const currentRow = findCurrentRow(quill);
       
       if (table && currentRow) {
         console.log('Tabela e linha encontradas, inserindo nova linha...');
         const newRow = document.createElement('tr');
         const colCount = currentRow.cells.length;
         
         for (let i = 0; i < colCount; i++) {
           const cell = document.createElement('td');
           cell.innerHTML = 'Nova célula';
           newRow.appendChild(cell);
         }
         
         currentRow.parentNode.insertBefore(newRow, currentRow.nextSibling);
         
         // Forçar atualização do Quill
         quill.update();
         console.log('Linha inserida com sucesso');
       } else {
         console.log('Tabela ou linha não encontradas');
         // Se não encontrou, tentar inserir na primeira tabela
         const tables = quill.root.querySelectorAll('table');
         if (tables.length > 0) {
           const table = tables[0];
           const rows = table.querySelectorAll('tr');
           if (rows.length > 0) {
             const lastRow = rows[rows.length - 1];
             console.log('Inserindo linha na primeira tabela...');
             const newRow = document.createElement('tr');
             const colCount = lastRow.cells.length;
             
             for (let i = 0; i < colCount; i++) {
               const cell = document.createElement('td');
               cell.innerHTML = 'Nova célula';
               newRow.appendChild(cell);
             }
             
             table.appendChild(newRow);
             quill.update();
             console.log('Linha inserida na primeira tabela');
           }
         }
       }
     }

     function insertColumnLeft(quill) {
       console.log('Tentando inserir coluna esquerda...');
       const table = findCurrentTable(quill);
       
       if (table) {
         console.log('Tabela encontrada, inserindo nova coluna...');
         const rows = table.querySelectorAll('tr');
         rows.forEach((row, index) => {
           const cell = document.createElement('td');
           cell.innerHTML = 'Nova célula';
           row.insertBefore(cell, row.firstChild);
         });
         
         // Forçar atualização do Quill
         quill.update();
         console.log('Coluna inserida com sucesso');
       } else {
         console.log('Tabela não encontrada');
         // Se não encontrou, tentar inserir na primeira tabela
         const tables = quill.root.querySelectorAll('table');
         if (tables.length > 0) {
           const table = tables[0];
           console.log('Inserindo coluna na primeira tabela...');
           const rows = table.querySelectorAll('tr');
           rows.forEach((row, index) => {
             const cell = document.createElement('td');
             cell.innerHTML = 'Nova célula';
             row.insertBefore(cell, row.firstChild);
           });
           quill.update();
           console.log('Coluna inserida na primeira tabela');
         }
       }
     }

     function insertColumnRight(quill) {
       console.log('Tentando inserir coluna direita...');
       const table = findCurrentTable(quill);
       
       if (table) {
         console.log('Tabela encontrada, inserindo nova coluna...');
         const rows = table.querySelectorAll('tr');
         rows.forEach((row, index) => {
           const cell = document.createElement('td');
           cell.innerHTML = 'Nova célula';
           row.appendChild(cell);
         });
         
         // Forçar atualização do Quill
         quill.update();
         console.log('Coluna inserida com sucesso');
       } else {
         console.log('Tabela não encontrada');
         // Se não encontrou, tentar inserir na primeira tabela
         const tables = quill.root.querySelectorAll('table');
         if (tables.length > 0) {
           const table = tables[0];
           console.log('Inserindo coluna na primeira tabela...');
           const rows = table.querySelectorAll('tr');
           rows.forEach((row, index) => {
             const cell = document.createElement('td');
             cell.innerHTML = 'Nova célula';
             row.appendChild(cell);
           });
           quill.update();
           console.log('Coluna inserida na primeira tabela');
         }
       }
     }

     function deleteRow(quill) {
       console.log('Tentando remover linha...');
       const table = findCurrentTable(quill);
       const currentRow = findCurrentRow(quill);
       
       if (table && currentRow) {
         const rows = table.querySelectorAll('tr');
         if (rows.length > 1) {
           currentRow.remove();
           quill.update();
           console.log('Linha removida com sucesso');
         } else {
           console.log('Não é possível remover a última linha');
         }
       } else {
         console.log('Tabela ou linha não encontradas');
         // Se não encontrou, tentar remover da primeira tabela
         const tables = quill.root.querySelectorAll('table');
         if (tables.length > 0) {
           const table = tables[0];
           const rows = table.querySelectorAll('tr');
           if (rows.length > 1) {
             rows[rows.length - 1].remove();
             quill.update();
             console.log('Linha removida da primeira tabela');
           } else {
             console.log('Não é possível remover a última linha da primeira tabela');
           }
         }
       }
     }

     function deleteColumn(quill) {
       console.log('Tentando remover coluna...');
       const table = findCurrentTable(quill);
       const currentCell = findCurrentCell(quill);
       
       if (table && currentCell) {
         const cellIndex = Array.from(currentCell.parentNode.children).indexOf(currentCell);
         const rows = table.querySelectorAll('tr');
         
         rows.forEach(row => {
           const cells = row.querySelectorAll('td, th');
           if (cells.length > 1 && cells[cellIndex]) {
             cells[cellIndex].remove();
           }
         });
         quill.update();
         console.log('Coluna removida com sucesso');
       } else {
         console.log('Tabela ou célula não encontradas');
         // Se não encontrou, tentar remover da primeira tabela
         const tables = quill.root.querySelectorAll('table');
         if (tables.length > 0) {
           const table = tables[0];
           const rows = table.querySelectorAll('tr');
           if (rows.length > 0) {
             const firstRow = rows[0];
             const cells = firstRow.querySelectorAll('td, th');
             if (cells.length > 1) {
               rows.forEach(row => {
                 const rowCells = row.querySelectorAll('td, th');
                 if (rowCells.length > 0) {
                   rowCells[rowCells.length - 1].remove();
                 }
               });
               quill.update();
               console.log('Coluna removida da primeira tabela');
             } else {
               console.log('Não é possível remover a última coluna da primeira tabela');
             }
           }
         }
       }
     }

     function deleteTable(quill) {
       console.log('Tentando remover tabela...');
       const table = findCurrentTable(quill);
       
       if (table) {
         table.remove();
         quill.update();
         console.log('Tabela removida com sucesso');
       } else {
         console.log('Tabela não encontrada');
         // Se não encontrou, tentar remover a primeira tabela
         const tables = quill.root.querySelectorAll('table');
         if (tables.length > 0) {
           tables[0].remove();
           quill.update();
           console.log('Primeira tabela removida');
         }
       }
     }

    function renderPreview() {
      const preview = document.getElementById('preview');
      let html = '<div class="page-builder-push"><div class="container">';
      containers.forEach((container) => {
        const containerClass = containerClasses[container.cols];
        html += `<div class="row ${containerClass}">\n`;
        container.blocks.forEach((col, colIdx) => {
          html += `<div class="${colClasses[container.cols][colIdx]}">\n`;
          col.forEach(block => {
            if (block.type === 'html') html += `${block.content}\n`;
            if (block.type === 'image') {
              if (block.link && block.link.trim()) {
                html += `<a href="${block.link}" target="_blank"><img src="${block.content}" alt="Imagem" /></a>\n`;
              } else {
                html += `<img src="${block.content}" alt="Imagem" />\n`;
              }
            }
          });
          html += `</div>\n`;
        });
        html += `</div>\n`;
      });
      html += '</div></div>';
      preview.innerHTML = html;
    }

    function generateCode() {
      let html = '<div class="page-builder-push"><div class="container">';
      containers.forEach((container) => {
        const containerClass = containerClasses[container.cols];
        html += `<div class="row ${containerClass}">\n`;
        container.blocks.forEach((col, colIdx) => {
          html += `<div class="${colClasses[container.cols][colIdx]}">\n`;
          col.forEach(block => {
            if (block.type === 'html') html += `${block.content}\n`;
            if (block.type === 'image') {
              if (block.link && block.link.trim()) {
                html += `<a href="${block.link}" target="_blank"><img src="${block.content}" alt="Imagem" /></a>\n`;
              } else {
                html += `<img src="${block.content}" alt="Imagem" />\n`;
              }
            }
          });
          html += `</div>\n`;
        });
        html += `</div>\n`;
      });
      html += '</div></div>';
      document.getElementById('output').value = html;
    }

    function copyCode() {
      const output = document.getElementById('output');
      output.select();
      document.execCommand('copy');
      
      // Feedback visual
      const button = event.target;
      const originalText = button.innerHTML;
      button.innerHTML = '<i class="fas fa-check"></i> Copiado!';
      button.style.background = '#28a745';
      
      setTimeout(() => {
        button.innerHTML = originalText;
        button.style.background = '';
      }, 2000);
    }

    // Funções para adicionar/remover colunas em containers existentes
    function addColumnToContainer(containerIdx) {
      const container = containers[containerIdx];
      if (container.cols >= 5) {
        alert('Máximo de 5 colunas permitido!');
        return;
      }
      
      // Adicionar nova coluna vazia
      container.blocks.push([]);
      container.cols = container.blocks.length;
      
      renderBuilder();
    }

    function removeColumnFromContainer(containerIdx) {
      const container = containers[containerIdx];
      if (container.cols <= 1) {
        alert('Mínimo de 1 coluna necessário!');
        return;
      }
      
      // Confirmar remoção se a coluna tem conteúdo
      const lastColumn = container.blocks[container.blocks.length - 1];
      if (lastColumn.length > 0) {
        const confirmRemove = confirm(`A última coluna contém ${lastColumn.length} bloco(s). Deseja realmente removê-la? Todo o conteúdo será perdido.`);
        if (!confirmRemove) {
          return;
        }
      }
      
      // Remover a última coluna
      container.blocks.pop();
      container.cols = container.blocks.length;
      
      renderBuilder();
    }

    // Função para controlar o menu dropdown de dados
    function toggleDataMenu() {
      const dropdown = document.getElementById('dataMenuDropdown');
      dropdown.classList.toggle('show');
    }

    // Fechar o menu quando clicar fora dele
    document.addEventListener('click', function(event) {
      const floatingMenu = document.querySelector('.floating-menu');
      const dropdown = document.getElementById('dataMenuDropdown');
      
      if (!floatingMenu.contains(event.target) && dropdown.classList.contains('show')) {
        dropdown.classList.remove('show');
      }
    });

    // Funções para localStorage
    function saveToLocalStorage() {
      try {
        const projectData = {
          containers: containers,
          containerCollapseStates: containerCollapseStates,
          timestamp: new Date().toISOString(),
          version: '1.0'
        };
        
        localStorage.setItem('pagebuilder_project', JSON.stringify(projectData));
        
        // Feedback visual
        const button = event.target;
        const originalText = button.innerHTML;
        button.innerHTML = '<i class="fas fa-check"></i> Salvo!';
        button.style.background = '#28a745';
        
        setTimeout(() => {
          button.innerHTML = originalText;
          button.style.background = '';
        }, 2000);
        
        console.log('Projeto salvo com sucesso!');
      } catch (error) {
        console.error('Erro ao salvar projeto:', error);
        alert('Erro ao salvar projeto. Verifique se há espaço suficiente no navegador.');
      }
    }

    function loadFromLocalStorage() {
      try {
        const savedData = localStorage.getItem('pagebuilder_project');
        
        if (!savedData) {
          alert('Nenhum projeto salvo encontrado!');
          return;
        }
        
        const projectData = JSON.parse(savedData);
        
        if (!projectData.containers || !Array.isArray(projectData.containers)) {
          alert('Dados do projeto corrompidos ou inválidos!');
          return;
        }
        
        // Confirmar carregamento se há containers existentes
        if (containers.length > 0) {
          const confirmLoad = confirm('Há containers existentes. Deseja substituí-los pelos dados salvos?');
          if (!confirmLoad) {
            return;
          }
        }
        
        containers = projectData.containers;
        
        // Carregar estados de colapso se existirem
        if (projectData.containerCollapseStates) {
          containerCollapseStates = projectData.containerCollapseStates;
        } else {
          // Se não existir, inicializar todos como expandidos
          containerCollapseStates = new Array(containers.length).fill('expanded');
        }
        
        // Feedback visual
        const button = event.target;
        const originalText = button.innerHTML;
        button.innerHTML = '<i class="fas fa-check"></i> Carregado!';
        button.style.background = '#28a745';
        
        setTimeout(() => {
          button.innerHTML = originalText;
          button.style.background = '';
        }, 2000);
        
        renderBuilder();
        console.log('Projeto carregado com sucesso!');
        
        // Mostrar informações do projeto carregado
        const timestamp = new Date(projectData.timestamp).toLocaleString('pt-BR');
        alert(`Projeto carregado com sucesso!\n\nSalvo em: ${timestamp}\nContainers: ${containers.length}`);
        
      } catch (error) {
        console.error('Erro ao carregar projeto:', error);
        alert('Erro ao carregar projeto. Os dados podem estar corrompidos.');
      }
    }

    function clearLocalStorage() {
      const confirmClear = confirm('Tem certeza que deseja limpar todos os dados salvos? Esta ação não pode ser desfeita.');
      
      if (confirmClear) {
        try {
          localStorage.removeItem('pagebuilder_project');
          
          // Feedback visual
          const button = event.target;
          const originalText = button.innerHTML;
          button.innerHTML = '<i class="fas fa-check"></i> Limpo!';
          button.style.background = '#28a745';
          
          setTimeout(() => {
            button.innerHTML = originalText;
            button.style.background = '';
          }, 2000);
          
          console.log('Dados limpos com sucesso!');
          alert('Todos os dados salvos foram removidos com sucesso!');
        } catch (error) {
          console.error('Erro ao limpar dados:', error);
          alert('Erro ao limpar dados.');
        }
      }
    }

    // Carregar projeto automaticamente ao iniciar (se existir)
    function autoLoadProject() {
      try {
        const savedData = localStorage.getItem('pagebuilder_project');
        if (savedData) {
          const projectData = JSON.parse(savedData);
          if (projectData.containers && Array.isArray(projectData.containers)) {
            containers = projectData.containers;
            
            // Carregar estados de colapso se existirem
            if (projectData.containerCollapseStates) {
              containerCollapseStates = projectData.containerCollapseStates;
            } else {
              // Se não existir, inicializar todos como expandidos
              containerCollapseStates = new Array(containers.length).fill('expanded');
            }
            
            console.log('Projeto carregado automaticamente do localStorage');
          }
        }
      } catch (error) {
        console.error('Erro ao carregar projeto automaticamente:', error);
      }
    }

    // Render inicial
    autoLoadProject();
    renderBuilder();
  </script>
</body>
</html>